<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>AI-Enhanced E-Commerce Data Engineering</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">AI-Enhanced E-Commerce Data Engineering</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./introduction.html"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./rag.html"> 
<span class="menu-text">RAG</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./agent.html" aria-current="page"> 
<span class="menu-text">Multi-Agents System</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./evaluation.html"> 
<span class="menu-text">Evaluation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./conclusion.html"> 
<span class="menu-text">Conclusion</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./demo.html"> 
<span class="menu-text">Demo</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/gu-dsan6725/spring-2025-final-project-project-group-3">
            Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/gu-dsan6725/spring-2025-final-project-project-group-3/tree/main/data">
            Data
            </a>
          </li>
      </ul>
    </div>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#multi-agent-system" id="toc-multi-agent-system" class="nav-link active" data-scroll-target="#multi-agent-system">Multi-Agent System</a>
  <ul class="collapse">
  <li><a href="#retrieval-and-prompt-generation-agent" id="toc-retrieval-and-prompt-generation-agent" class="nav-link" data-scroll-target="#retrieval-and-prompt-generation-agent">Retrieval and Prompt Generation Agent</a></li>
  <li><a href="#code-generation-agent" id="toc-code-generation-agent" class="nav-link" data-scroll-target="#code-generation-agent">Code Generation Agent</a></li>
  <li><a href="#code-execution-agent" id="toc-code-execution-agent" class="nav-link" data-scroll-target="#code-execution-agent">Code Execution Agent</a></li>
  <li><a href="#example-usage" id="toc-example-usage" class="nav-link" data-scroll-target="#example-usage">Example Usage</a>
  <ul class="collapse">
  <li><a href="#stage-1-analyzing-data-file-and-generating-cleaning-instructions" id="toc-stage-1-analyzing-data-file-and-generating-cleaning-instructions" class="nav-link" data-scroll-target="#stage-1-analyzing-data-file-and-generating-cleaning-instructions">üîç STAGE 1: Analyzing data file and generating cleaning instructions‚Ä¶</a></li>
  <li><a href="#stage-2-generating-data-cleaning-code-based-on-instructions" id="toc-stage-2-generating-data-cleaning-code-based-on-instructions" class="nav-link" data-scroll-target="#stage-2-generating-data-cleaning-code-based-on-instructions">üîß STAGE 2: Generating data cleaning code based on instructions‚Ä¶</a></li>
  <li><a href="#stage-3-executing-cleaning-code-attempt-14" id="toc-stage-3-executing-cleaning-code-attempt-14" class="nav-link" data-scroll-target="#stage-3-executing-cleaning-code-attempt-14">‚öôÔ∏è STAGE 3: Executing cleaning code (attempt 1/4)‚Ä¶</a></li>
  <li><a href="#error-occured---regenerating-code" id="toc-error-occured---regenerating-code" class="nav-link" data-scroll-target="#error-occured---regenerating-code">Error Occured - Regenerating Code</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="multi-agent-system" class="level1">
<h1>Multi-Agent System</h1>
<p>Multi-Agent Systems (MAS) are systems composed of multiple interacting agents, where each agent is an autonomous entity capable of perceiving its environment, making decisions, and taking actions independently or in collaboration with other agents.These agents can cooperate, compete, negotiate, or coordinate to achieve individual or collective goals <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>In this project, we utilized cooperative multi-agent system, and each agent will work cooperatively, and indepently focus on its assigned task. <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Three agents will be implemented in order to clean up the e-commerce datasets: retrieval and prompt generation agent, code generation agent, and code execution agent. We will use the OpenAI API <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> , gpt-4o model, for all the processes.</p>
<p><img src="./pics/multi-agent.png" class="img-fluid"></p>
<section id="retrieval-and-prompt-generation-agent" class="level2">
<h2 class="anchored" data-anchor-id="retrieval-and-prompt-generation-agent">Retrieval and Prompt Generation Agent</h2>
<p>The retrieval agent is responsible for format detection, schema extraction, contextual retrieval via FAISS and returns a structured context prompt. When a dataset is fed to the agent, it will identify whether it is CSV, JSON, XML, or XLSX using filename suffixes. From here, the file will be parsed to extract structural metadata like column names, types, and sample rows. The agent will query the FAISS vector database for sample data schemas, clean-up rules, and prompt examples for transformation. Eventually a prompt will be generated with matched schema, transformation rules, and examples to be consumed by the generation agent. This framework will be implemented through LangChain Tool abstraction.</p>
</section>
<section id="code-generation-agent" class="level2">
<h2 class="anchored" data-anchor-id="code-generation-agent">Code Generation Agent</h2>
<p>The code generation agent is responsible for code generation. The agent takes the prompt from the first agent and generates python code for cleaning and transforming the input data.</p>
</section>
<section id="code-execution-agent" class="level2">
<h2 class="anchored" data-anchor-id="code-execution-agent">Code Execution Agent</h2>
<p>This agent runs the generated code from the second agent to clean the raw data and save the cleaned dataset in the file path. If an error occurs, the error message will be sent back to the second agent to regenerate code, and this agent will run the newly generated code again until it saves the cleaned dataset successfully.</p>
</section>
<section id="example-usage" class="level2">
<h2 class="anchored" data-anchor-id="example-usage">Example Usage</h2>
<section id="stage-1-analyzing-data-file-and-generating-cleaning-instructions" class="level3">
<h3 class="anchored" data-anchor-id="stage-1-analyzing-data-file-and-generating-cleaning-instructions">üîç STAGE 1: Analyzing data file and generating cleaning instructions‚Ä¶</h3>
<p>‚úÖ Cleaning instructions generated successfully!</p>
<p>================================================================================ CLEANING INSTRUCTIONS: To clean and preprocess the dataset <code>makeup.csv</code>, follow these detailed instructions:</p>
<ol type="1">
<li>Handling Missing Values</li>
</ol>
<ul>
<li><strong>Prime Column</strong>: There is one missing value in the <code>Prime</code> column. Since this column indicates whether a product is available with Amazon Prime, you can fill the missing value with ‚ÄúNot Available‚Äù or ‚ÄúNo‚Äù if the context allows, assuming non-Prime availability.</li>
</ul>
<ol start="2" type="1">
<li>Detecting and Treating Outliers</li>
</ol>
<ul>
<li><strong>Star Ratings</strong>: The <code>star</code> column has a minimum value of 2.8, which might be an outlier given the mean of 4.26. Review these entries to ensure they are valid. If they are valid, retain them; otherwise, consider removing or flagging them for further review.</li>
<li><strong>Order and Page Number</strong>: These columns seem to have reasonable ranges given the context (order of appearance and page number), so no immediate action is needed unless business logic dictates otherwise.</li>
</ul>
<ol start="3" type="1">
<li>Data Type Issues and Conversions</li>
</ol>
<ul>
<li><strong>ReviewsCount</strong>: Convert this column from <code>object</code> to <code>int64</code>. First, remove commas from the numbers and then convert.</li>
<li><strong>Price</strong>: Convert this column from <code>object</code> to <code>float64</code>. Remove the dollar sign <code>$</code> before conversion.</li>
<li><strong>Prime</strong>: Convert this column to a boolean type where ‚ÄúAmazon Prime‚Äù is <code>True</code> and any other value or missing is <code>False</code>.</li>
</ul>
<ol start="4" type="1">
<li>Format Standardization</li>
</ol>
<ul>
<li><strong>ÂΩìÂâçÊó∂Èó¥</strong>: This column is already in a datetime format, but ensure it is recognized as such by converting it to <code>datetime64[ns]</code> if necessary.</li>
<li><strong>Price</strong>: Ensure all prices are in a consistent currency format, assuming USD based on the dollar sign.</li>
</ul>
<ol start="5" type="1">
<li>Categorical Encoding</li>
</ol>
<ul>
<li><strong>Key Words</strong>: Convert this column to a categorical type. If needed for modeling, use one-hot encoding.</li>
<li><strong>Prime</strong>: As mentioned, convert to boolean for easier analysis.</li>
</ul>
<ol start="6" type="1">
<li>Text Fields Cleaning and Normalization</li>
</ol>
<ul>
<li><strong>Title</strong>: Normalize text by converting to lowercase to ensure consistency in text analysis.</li>
<li><strong>Title URL</strong>: This column seems to be a URL and might not need cleaning unless used for specific analysis.</li>
</ul>
<ol start="7" type="1">
<li>Identifying Potential Duplicates</li>
</ol>
<ul>
<li><strong>Duplicate Rows</strong>: The dataset reports zero duplicate rows. However, ensure there are no logical duplicates by checking for identical <code>asin</code> values, as this should be unique for each product.</li>
</ul>
<ol start="8" type="1">
<li>Renaming Columns for Clarity</li>
</ol>
<ul>
<li><strong>ÂΩìÂâçÊó∂Èó¥</strong>: Rename to <code>current_time</code> for consistency and clarity.</li>
<li><strong>Title URL</strong>: Rename to <code>product_url</code> for clarity.</li>
</ul>
<ol start="9" type="1">
<li>Derived Features</li>
</ol>
<ul>
<li><strong>Review to Price Ratio</strong>: Create a new feature by dividing <code>ReviewsCount</code> by <code>price</code> to understand the review density relative to price.</li>
<li><strong>Star to Price Ratio</strong>: Create a new feature by dividing <code>star</code> by <code>price</code> to assess value for money based on ratings.</li>
<li><strong>Is Prime</strong>: As a boolean feature, this can be used directly in models to understand the impact of Prime availability.</li>
</ul>
<p>Additional StepsÔºö</p>
<ul>
<li><strong>Data Validation</strong>: After cleaning, validate the data types and check for any remaining inconsistencies.</li>
<li><strong>Documentation</strong>: Document all changes made to the dataset for reproducibility and future reference.</li>
</ul>
<p>By following these steps, you will ensure the dataset is clean, consistent, and ready for analysis or modeling.</p>
<p>================================================================================</p>
</section>
<section id="stage-2-generating-data-cleaning-code-based-on-instructions" class="level3">
<h3 class="anchored" data-anchor-id="stage-2-generating-data-cleaning-code-based-on-instructions">üîß STAGE 2: Generating data cleaning code based on instructions‚Ä¶</h3>
<p>‚úÖ Cleaning code generated successfully!</p>
<p>üíæ Cleaning code saved to /Users/sherryqin/Desktop/agent/clean_makeup_attempt1.py</p>
<p>================================================================================</p>
</section>
<section id="stage-3-executing-cleaning-code-attempt-14" class="level3">
<h3 class="anchored" data-anchor-id="stage-3-executing-cleaning-code-attempt-14">‚öôÔ∏è STAGE 3: Executing cleaning code (attempt 1/4)‚Ä¶</h3>
<p>Executing cleaning code‚Ä¶ Warning: No main() function found in generated code. Trying subprocess execution‚Ä¶ Error executing cleaning code: STDOUT: STDERR: /Users/sherryqin/Desktop/agent/clean_makeup_attempt1.py:13: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method. The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.</p>
<p>For example, when doing ‚Äòdf[col].method(value, inplace=True)‚Äô, try using ‚Äòdf.method({col: value}, inplace=True)‚Äô or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.</p>
<p>df[‚ÄòPrime‚Äô].fillna(‚ÄòNo‚Äô, inplace=True)</p>
<div class="scrolling">
<pre><code>Traceback (most recent call last):
File "/Users/sherryqin/Desktop/agent/clean_makeup_attempt1.py", line 73, in &lt;module&gt;
    clean_makeup_data(filepath)
File "/Users/sherryqin/Desktop/agent/clean_makeup_attempt1.py", line 21, in clean_makeup_data
    df['ReviewsCount'] = df['ReviewsCount'].str.replace(',', '').astype('int64')
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/Users/sherryqin/anaconda3/lib/python3.11/site-packages/pandas/core/generic.py", line 6643, in astype
    new_data = self._mgr.astype(dtype=dtype, copy=copy, errors=errors)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/Users/sherryqin/anaconda3/lib/python3.11/site-packages/pandas/core/internals/managers.py", line 430, in astype
    return self.apply(
        ^^^^^^^^^^^
File "/Users/sherryqin/anaconda3/lib/python3.11/site-packages/pandas/core/internals/managers.py", line 363, in apply
    applied = getattr(b, f)(**kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^
File "/Users/sherryqin/anaconda3/lib/python3.11/site-packages/pandas/core/internals/blocks.py", line 758, in astype
    new_values = astype_array_safe(values, dtype, copy=copy, errors=errors)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/Users/sherryqin/anaconda3/lib/python3.11/site-packages/pandas/core/dtypes/astype.py", line 237, in astype_array_safe
    new_values = astype_array(values, dtype, copy=copy)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/Users/sherryqin/anaconda3/lib/python3.11/site-packages/pandas/core/dtypes/astype.py", line 182, in astype_array
    values = _astype_nansafe(values, dtype, copy=copy)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
File "/Users/sherryqin/anaconda3/lib/python3.11/site-packages/pandas/core/dtypes/astype.py", line 133, in _astype_nansafe
    return arr.astype(dtype, copy=True)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: cannot convert float NaN to integer</code></pre>
</div>
<p>‚ùå Execution failed. Error: Error executing cleaning code:</p>
<p>STDOUT:</p>
<p>STDERR: /Users/sherryqin/Desktop/agent/clean_makeup_attempt1.py:13:</p>
<p>FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.</p>
<p>The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.</p>
<p>For example, when doing ‚Äòdf[col].method(value, inplace=True)‚Äô, try using ‚Äòdf.method({col: value}, inplace=True)‚Äô or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.</p>
<p>================================================================================</p>
</section>
<section id="error-occured---regenerating-code" class="level3">
<h3 class="anchored" data-anchor-id="error-occured---regenerating-code">Error Occured - Regenerating Code</h3>
<p>üîÑ Attempting code regeneration (1/3)‚Ä¶</p>
<section id="stage-2-regenerating-data-cleaning-code-based-on-instructions" class="level4">
<h4 class="anchored" data-anchor-id="stage-2-regenerating-data-cleaning-code-based-on-instructions">üîß STAGE 2: ReGenerating data cleaning code based on instructions‚Ä¶</h4>
<p>‚úÖ Cleaning code regenerated successfully!</p>
<p>üíæ Cleaning code saved to /Users/sherryqin/Desktop/agent/clean_makeup_attempt2.py</p>
</section>
<section id="stage-3-executing-cleaning-code-attempt-24" class="level4">
<h4 class="anchored" data-anchor-id="stage-3-executing-cleaning-code-attempt-24">‚öôÔ∏è STAGE 3: Executing cleaning code (attempt 2/4)‚Ä¶</h4>
<p>Executing cleaning code‚Ä¶ Warning: No main() function found in generated code. Trying subprocess execution‚Ä¶</p>
<p>================================================================================</p>
<p>‚úÖ Cleaning completed successfully! Cleaned data saved to cleaned_makeup.csv</p>
<p>üéâ The complete data cleaning pipeline finished successfully! Original data: makeup.csv</p>
<p>Cleaned data: cleaned_makeup.csv</p>
<p>DATA SUMMARY:</p>
<p>Rows: 1006</p>
<p>Columns: 13</p>
<p>Missing values: 145</p>


</section>
</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>https://www.cs.ox.ac.uk/people/michael.wooldridge/pubs/imas/IMAS2e.html<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p>https://www.ibm.com/think/topics/multiagent-system<a href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn3"><p>https://platform.openai.com/docs/overview<a href="#fnref3" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>